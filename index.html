<!DOCTYPE html>
<html lang='en-US'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>whenmap</title>

  <link rel=icon href='data:image/png;base64,' />
</head>
<body>
<ul>
  <li><a href='./unittest.html'>./unittest.html</a>
</ul>

<script type=module>
import {whenmap, whencall, as_whenmap_proxy} from './esm/index.js'

const demo = whenmap()
demo.subscribe((key, value) => {
  console.log('whenmap update! key: %o => value: %o', key, value)
})

Object.assign(window, { whenmap, whencall, demo })


demo.set('aaa', 'This is AAA')

whencall(demo, {
  name: 'neato',
  with_whenmap: as_whenmap_proxy,
  async update(pxy, name) {
    console.log('Compute NEATO! %o', name)
    let a = await pxy.aaa
    let b = await pxy.bbb
    let c = await pxy.ccc
    return JSON.stringify({name, a, b, c})
  },
})

whencall(demo, {
  name: 'neato_keen',
  async update(ns, name) {
    console.log('Compute NEATO_KEEN! %o', name)
    let a = await ns.when('aaa')
    let b = await ns.when('bbb')
    let c = await ns.when('ccc')
    return JSON.stringify({name, a, b, c})
  },
})


demo.set('bbb', ['BBB', 'is', 'an', 'array'])
demo.set('ccc', {ccc_value: 1942})

console.log('End', Object.fromEntries(demo.entries()))
</script>
